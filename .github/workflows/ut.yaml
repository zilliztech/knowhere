name: Unit Test

# This workflow is triggered on pushes or pull request to the repository.
on:
  push:
    branches:
      - main
  pull_request:
    # File paths to consider in the event. Optional; defaults to all.
    paths:
      - "include/**"
      - "python/**"
      - "src/**"
      - "thirdparty/**"
      - "benchmark/**"
      - "cmake/**"
      - "!cmake/libs/libcardinal.cmake"
      - ".github/workflows/ut.yaml"
      - "CMakeLists.txt"
      - "!**.md"
      - "tests/**"

jobs:
  ut:
    name: ut on ubuntu-22.04
    runs-on: self-hosted
    timeout-minutes: 180
    strategy:
      fail-fast: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: 'none'
      - name: Install Dependency
        run: |
          sudo apt update \
          && sudo apt install -y g++ gcc libopenblas-openmp-dev libcurl4-openssl-dev libaio-dev libevent-dev python3 python3-pip lcov ccache \
          && sudo pip3 install cmake==3.28.1 conan==1.61.0 \
          && (conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local || true)
      - name: Restore Cache
        uses: ./.github/actions/cache-restore
        with:
          os: ubuntu-22.04
      - name: Build
        run: |
          mkdir build && cd build \
          && conan install .. --build=missing -s build_type=Release -o with_ut=True -o with_diskann=True -o with_asan=True -o with_coverage=True -s compiler.libcxx=libstdc++11 \
          && conan build ..
      - name: Run Unit Tests
        run: |
          cd build/Release/tests/ut \
          && ./knowhere_tests
      - name: Generate and Print Coverage Report
        if: always()
        run: |
          echo "=========================================="
          echo "         CODE COVERAGE REPORT"
          echo "=========================================="
          lcov --capture --directory build/ --output-file coverage.info --rc lcov_branch_coverage=1 2>/dev/null \
          && lcov --remove coverage.info \
              '/usr/*' \
              '*/.conan/*' \
              '*/thirdparty/*' \
              '*/tests/*' \
              '*/build/*' \
              --output-file coverage.info --rc lcov_branch_coverage=1 2>/dev/null \
          && echo "" \
          && lcov --summary coverage.info 2>/dev/null \
          && echo "" \
          && echo "=========================================="
      - name: Save Cache
        uses: ./.github/actions/cache-save
        with:
          os: ubuntu-22.04

  swig-build:
    name: python3 wheel
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: 'none'
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
      - name: Install Dependency
        run: |
          sudo apt update \
          && sudo apt install -y cmake g++ gcc libopenblas-openmp-dev libaio-dev libcurl4-openssl-dev libevent-dev libgflags-dev python3 python3-pip python3-setuptools ccache unzip binutils patchelf \
          && pip3 install conan==1.61.0 pytest faiss-cpu numpy wheel \
          && pip3 install bfloat16 \
          && (conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local || true) \
          && pip3 install -U setuptools
      - name: Restore Cache
        uses: ./.github/actions/cache-restore
        with:
          os: ubuntu-22.04
      - name: Build
        run: |
          mkdir build \
          && cd build \
          && conan install .. --build=missing -o with_diskann=True -s compiler.libcxx=libstdc++11 -s build_type=Release \
          && conan build ..
      - name: Save Cache
        uses: ./.github/actions/cache-save
        with:
          os: ubuntu-22.04
      - name: Build Portable Wheel
        run: |
          cd python && ./build_portable_wheel.sh
      - name: Install Wheel
        run: |
          cd python && pip3 install dist/*-manylinux*.whl
      - name: Test
        run: |
          pytest tests/python/test_index_with_random.py
